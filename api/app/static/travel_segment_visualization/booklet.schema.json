{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://eti360.local/schemas/travel-segment-visualization/v1/booklet.schema.json",
  "title": "ETI360 Travel Segment Booklet (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "trip", "segments"],
  "properties": {
    "version": {
      "type": "string",
      "const": "v1"
    },
    "trip": {
      "type": "object",
      "additionalProperties": false,
      "required": ["trip_id", "trip_name", "default_timezone", "brand", "map", "created_at"],
      "properties": {
        "trip_id": { "type": "string", "minLength": 1 },
        "trip_name": { "type": "string", "minLength": 1 },
        "default_timezone": { "type": "string", "minLength": 1 },
        "created_at": {
          "type": "string",
          "description": "ISO-8601 timestamp (UTC) when this JSON was generated.",
          "minLength": 1
        },
        "brand": {
          "type": "object",
          "additionalProperties": false,
          "required": ["eti360_blue"],
          "properties": {
            "eti360_blue": {
              "type": "object",
              "additionalProperties": false,
              "required": ["hex", "print_fidelity"],
              "properties": {
                "hex": {
                  "type": "string",
                  "description": "Authoritative for web/Mapbox overlays. Format: #RRGGBB.",
                  "pattern": "^#[0-9A-Fa-f]{6}$"
                },
                "print_fidelity": {
                  "type": "string",
                  "description": "Whether CMYK values are authoritative from the brand spec or an approximation derived from HEX.",
                  "enum": ["authoritative", "approximation"]
                },
                "cmyk": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["c", "m", "y", "k"],
                  "properties": {
                    "c": { "type": "number", "minimum": 0, "maximum": 100 },
                    "m": { "type": "number", "minimum": 0, "maximum": 100 },
                    "y": { "type": "number", "minimum": 0, "maximum": 100 },
                    "k": { "type": "number", "minimum": 0, "maximum": 100 }
                  }
                }
              }
            }
          }
        },
        "map": {
          "type": "object",
          "additionalProperties": false,
          "required": ["provider", "style_ref", "style_version", "image"],
          "properties": {
            "provider": { "type": "string", "const": "mapbox" },
            "style_ref": {
              "type": "string",
              "description": "Mapbox Style URL or style ID reference used for static maps.",
              "minLength": 1
            },
            "style_version": {
              "type": "string",
              "description": "Internal version tag for the style JSON (governance/versioning).",
              "minLength": 1
            },
            "image": {
              "type": "object",
              "additionalProperties": false,
              "required": ["width_px", "height_px", "scale"],
              "properties": {
                "width_px": { "type": "integer", "minimum": 1 },
                "height_px": { "type": "integer", "minimum": 1 },
                "scale": {
                  "type": "integer",
                  "description": "Mapbox static image scale factor. Common values: 1 or 2.",
                  "enum": [1, 2]
                }
              }
            }
          }
        }
      }
    },
    "segments": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/segment" }
    }
  },
  "$defs": {
    "segment": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "segment_id",
        "trip_id",
        "segment_order",
        "segment_name",
        "date_local",
        "departure_time_local",
        "timezone",
        "mode",
        "environment",
        "origin",
        "destination",
        "derived",
        "assets"
      ],
      "properties": {
        "segment_id": { "type": "string", "minLength": 1 },
        "trip_id": { "type": "string", "minLength": 1 },
        "segment_order": { "type": "integer", "minimum": 1 },
        "segment_name": { "type": "string", "minLength": 1 },
        "date_local": { "type": "string", "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$" },
        "departure_time_local": { "type": "string", "pattern": "^[0-9]{2}:[0-9]{2}$" },
        "timezone": { "type": "string", "minLength": 1 },
        "mode": {
          "type": "string",
          "enum": ["coach", "walking", "train", "metro", "subway", "tram", "air", "ferry", "small_craft"]
        },
        "environment": {
          "type": "object",
          "additionalProperties": false,
          "required": ["value", "source"],
          "properties": {
            "value": { "type": "string", "enum": ["Urban", "Suburban", "Rural", "Remote"] },
            "source": { "type": "string", "enum": ["auto", "override"] }
          }
        },
        "origin": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "lat", "lng"],
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "lat": { "type": "number", "minimum": -90, "maximum": 90 },
            "lng": { "type": "number", "minimum": -180, "maximum": 180 }
          }
        },
        "destination": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "lat", "lng"],
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "lat": { "type": "number", "minimum": -90, "maximum": 90 },
            "lng": { "type": "number", "minimum": -180, "maximum": 180 }
          }
        },
        "derived": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "base_duration_min",
            "expected_duration_min",
            "expected_duration_max",
            "distance_km",
            "distance_miles",
            "arrival_window_start_local",
            "arrival_window_end_local",
            "route_geometry"
          ],
          "properties": {
            "base_duration_min": { "type": "integer", "minimum": 0 },
            "expected_duration_min": { "type": "integer", "minimum": 0 },
            "expected_duration_max": { "type": "integer", "minimum": 0 },
            "distance_km": { "type": "number", "minimum": 0 },
            "distance_miles": { "type": "number", "minimum": 0 },
            "arrival_window_start_local": { "type": "string", "pattern": "^[0-9]{2}:[0-9]{2}$" },
            "arrival_window_end_local": { "type": "string", "pattern": "^[0-9]{2}:[0-9]{2}$" },
            "route_geometry": {
              "type": "object",
              "additionalProperties": false,
              "required": ["type", "source", "geojson"],
              "properties": {
                "type": { "type": "string", "const": "LineString" },
                "source": {
                  "type": "string",
                  "enum": ["mapbox_directions", "straight_line", "manual_override"]
                },
                "profile_used": {
                  "type": "string",
                  "description": "Routing profile actually used to obtain the corridor geometry. Rail modes may fall back to driving when true transit routing is unavailable.",
                  "enum": ["driving", "walking", "transit", "unknown"]
                },
                "is_fallback": {
                  "type": "boolean",
                  "description": "True when the geometry was generated via an explicit fallback (e.g., rail mode rendered using driving corridor)."
                },
                "geojson": {
                  "type": "object",
                  "description": "GeoJSON Feature with LineString geometry in WGS84.",
                  "additionalProperties": true
                }
              }
            }
          }
        },
        "assets": {
          "type": "object",
          "additionalProperties": false,
          "required": ["map_png", "qr_png", "qr_target_url"],
          "properties": {
            "map_png": {
              "type": "object",
              "additionalProperties": false,
              "required": ["s3_url", "width_px", "height_px", "content_hash"],
              "properties": {
                "s3_url": { "type": "string", "minLength": 1 },
                "width_px": { "type": "integer", "minimum": 1 },
                "height_px": { "type": "integer", "minimum": 1 },
                "content_hash": {
                  "type": "string",
                  "description": "Hash for reproducibility/cache (e.g., sha256 hex).",
                  "minLength": 1
                }
              }
            },
            "qr_png": {
              "type": "object",
              "additionalProperties": false,
              "required": ["s3_url", "width_px", "height_px", "content_hash"],
              "properties": {
                "s3_url": { "type": "string", "minLength": 1 },
                "width_px": { "type": "integer", "minimum": 1 },
                "height_px": { "type": "integer", "minimum": 1 },
                "content_hash": { "type": "string", "minLength": 1 }
              }
            },
            "qr_target_url": {
              "type": "string",
              "description": "Public orientation map URL encoded into the QR.",
              "minLength": 1
            }
          }
        }
      }
    }
  }
}
